name: Fetch Strapi Food

on:
  schedule:
    - cron: "0 */1 * * *" # 建議改為每小時執行一次，原先的 */55 可能過於頻繁
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-food:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install node-fetch
        run: npm install node-fetch@3

      - name: Fetch food from Strapi
        env:
          STRAPI_URL: ${{ secrets.STRAPI_URL }}
          STRAPI_TOKEN: ${{ secrets.STRAPI_TOKEN }}
        run: |
          node --input-type=module -e '
          import fetch from "node-fetch";
          import fs from "fs";

          const baseUrl = (process.env.STRAPI_URL || "").replace(/\/$/, "");
          const url = `${baseUrl}/api/foods?populate=photo`;
          const headers = { 
            Authorization: `Bearer ${process.env.STRAPI_TOKEN}`,
            Accept: "application/json"
          };

          console.log("Fetching from:", url);

          try {
            const res = await fetch(url, { headers });
            const text = await res.text();
            
            if (!res.ok) {
              console.error(`HTTP Error: ${res.status}\nContent: ${text.substring(0, 200)}`);
              process.exit(1);
            }

            const data = JSON.parse(text);
            const foods = (data.data || []).map(item => {
              const attrs = item.attributes || item;
              const photoData = attrs.photo?.data || attrs.photo;
              const photo = Array.isArray(photoData) 
                ? photoData.map(p => p.attributes?.url || p.url || "") 
                : (photoData ? [photoData.attributes?.url || photoData.url || ""] : []);
              
              return {
                id: item.id,
                name: attrs.name || "",
                amount: attrs.amount || 0,
                price: attrs.price || 0,
                shop: attrs.shop || "",
                todate: attrs.todate || "",
                photo: photo.filter(Boolean),
                photoHash: attrs.photoHash || ""
              };
            });

            fs.writeFileSync("food.json", JSON.stringify(foods, null, 2));
            console.log(`Success: ${foods.length} items saved.`);
          } catch (error) {
            console.error("Script Error:", error.message);
            process.exit(1);
          }
          '

      - name: Commit & push food.json
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          if [[ -n $(git status -s food.json) ]]; then
            git add food.json
            git commit -m "Update food.json [skip ci]"
            git push
            echo "Changes pushed to repository." 
          else
            echo "No changes in food.json, skipping commit."
          fi
